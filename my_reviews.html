<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soko freshi Store - My Reviews</title>
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <link rel="shortcut icon" href="images/favicon.png" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css" integrity="sha384-eLT4eRYPHTmTsFGFAzjcCWX+wHfUInVWNm9YnwpiatljsZOwXtwV2Hh6sHM6zZD9" crossorigin="anonymous" />
  <style>
    .reviews-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .reviews-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      flex: 1;
      min-width: 200px;
      text-align: center;
    }
    .summary-card .icon {
      font-size: 24px;
      color: #0dd134;
      margin-bottom: 10px;
    }
    .summary-card .count {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .summary-card .label {
      color: #666;
      font-size: 14px;
    }
    .reviews-list {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .review-item {
      display: flex;
      border-bottom: 1px solid #eee;
      padding: 20px;
    }
    .review-item:last-child {
      border-bottom: none;
    }
    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 20px;
    }
    .review-content {
      flex: 1;
    }
    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .review-date {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .review-rating {
      color: #ffc107;
      margin-bottom: 10px;
    }
    .review-text {
      margin-bottom: 10px;
    }
    .review-title {
      font-weight: 500;
      margin-bottom: 5px;
    }
    .review-body {
      color: #333;
      line-height: 1.5;
    }
    .review-actions {
      display: flex;
      gap: 10px;
    }
    .review-btn {
      padding: 5px 10px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    .edit-btn {
      background-color: #f8f9fa;
      color: #333;
      border: 1px solid #ddd;
    }
    .delete-btn {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .empty-reviews {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-reviews i {
      font-size: 60px;
      color: #ddd;
      margin-bottom: 20px;
    }
    .empty-reviews h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .empty-reviews p {
      color: #666;
      margin-bottom: 20px;
    }
    .shop-now-btn {
      display: inline-block;
      background-color: #0dd134;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <nav class="navigation">
    <a href="customer_dashboard.html" class="logo">
      Soko freshi
    </a>
    <input type="checkbox" class="menu-btn" id="menu-btn">
    <label for="menu-btn" class="menu-icon">
      <span class="nav-icon"></span>
    </label>
    <ul class="menu">
      <li><a href="customer_dashboard.html">Dashboard</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="my_orders.html">My Orders</a></li>
    </ul>
    <div class="right-nav">
      <a href="#" class="like">
        <i class="far fa-heart"></i>
        <span>0</span>
      </a>
      <a href="cart.html" class="cart">
        <i class="fa fa-shopping-cart"></i>
        <span>0</span>
      </a>
      <a href="#" id="logout-btn" class="logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </nav>

  <section id="popular-product">
    <div class="product-heading">
      <h3>My Reviews</h3>
      <span></span>
    </div>
    
    <div class="reviews-container">
      <div class="reviews-summary">
        <div class="summary-card">
          <div class="icon"><i class="fas fa-star"></i></div>
          <div class="count" id="total-reviews">0</div>
          <div class="label">Total Reviews</div>
        </div>
        <div class="summary-card">
          <div class="icon"><i class="fas fa-shopping-bag"></i></div>
          <div class="count" id="products-reviewed">0</div>
          <div class="label">Products Reviewed</div>
        </div>
        <div class="summary-card">
          <div class="icon"><i class="fas fa-chart-line"></i></div>
          <div class="count" id="average-rating">0.0</div>
          <div class="label">Average Rating</div>
        </div>
      </div>
      
      <div id="reviews-list">
        <!-- Reviews will be loaded here -->
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-container">
      <div class="footer-logo">
        <a href="#">Soko freshi</a>
        <div class="footer-social">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-links">
        <strong>Quick Links</strong>
        <ul>
          <li><a href="customer_dashboard.html">Dashboard</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="my_orders.html">My Orders</a></li>
          <li><a href="contact.html">Contact Us</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <strong>Categories</strong>
        <ul>
          <li><a href="products.html?category=Fruits">Fruits</a></li>
          <li><a href="products.html?category=Vegetables">Vegetables</a></li>
          <li><a href="products.html?category=Fish & Meat">Fish & Meat</a></li>
          <li><a href="products.html?category=Spices">Spices</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <strong>Contact Us</strong>
        <ul>
          <li><i class="fas fa-map-marker-alt"></i> 123, ABC Street, XYZ City</li>
          <li><i class="fas fa-phone-alt"></i> +254 758 599393</li>
          <li><i class="fas fa-envelope"></i> angie@gmail.com</li>
        </ul>
      </div>
    </div>
  </footer>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="js/product-manager.js"></script>
  <script src="js/reviews.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB4H9MQ76i1p3tThi6Zoc-AGbfnqjBSLRI",
      authDomain: "efresh-56b75.firebaseapp.com",
      projectId: "efresh-56b75",
      storageBucket: "efresh-56b75.firebasestorage.app",
      messagingSenderId: "253998754664",
      appId: "1:253998754664:web:889840cf5d84ef903a84dd"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM elements
    const totalReviewsEl = document.getElementById('total-reviews');
    const productsReviewedEl = document.getElementById('products-reviewed');
    const averageRatingEl = document.getElementById('average-rating');
    const reviewsListEl = document.getElementById('reviews-list');
    
    // Check if user is logged in
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // User is logged in
        try {
          // Get user data
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            
            // Check if user is a customer
            if (userData.role && userData.role !== 'customer') {
              alert('This page is for customers only.');
              window.location.href = 'index.html';
              return;
            }
          }
          
          // Load user's reviews
          loadUserReviews(user.uid);
          
        } catch (error) {
          console.error("Error loading user data:", error);
          alert('Error loading your data. Please try again later.');
        }
      } else {
        // Not logged in, redirect to login
        window.location.href = 'login.html';
      }
    });
    
    // Load user's reviews
    async function loadUserReviews(userId) {
      try {
        // Get reviews from Firestore
        const reviewsQuery = await db.collection('reviews')
          .where('userId', '==', userId)
          .orderBy('createdAt', 'desc')
          .get();
        
        if (reviewsQuery.empty) {
          // No reviews found
          showEmptyState();
          return;
        }
        
        const reviews = [];
        reviewsQuery.forEach(doc => {
          reviews.push({
            id: doc.id,
            ...doc.data(),
            createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date()
          });
        });
        
        // Update summary
        updateSummary(reviews);
        
        // Display reviews
        displayReviews(reviews);
        
      } catch (error) {
        console.error("Error loading reviews:", error);
        reviewsListEl.innerHTML = `
          <div class="empty-reviews">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Error Loading Reviews</h3>
            <p>There was a problem loading your reviews. Please try again later.</p>
          </div>
        `;
      }
    }
    
    // Update summary
    function updateSummary(reviews) {
      // Total reviews
      totalReviewsEl.textContent = reviews.length;
      
      // Products reviewed (unique products)
      const uniqueProducts = new Set(reviews.map(review => review.productId));
      productsReviewedEl.textContent = uniqueProducts.size;
      
      // Average rating
      const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
      const averageRating = totalRating / reviews.length;
      averageRatingEl.textContent = averageRating.toFixed(1);
    }
    
    // Display reviews
    async function displayReviews(reviews) {
      reviewsListEl.innerHTML = '';
      
      // Get all products
      const products = productManager.getAllProducts();
      
      // Create HTML for each review
      for (const review of reviews) {
        // Get product details
        let product = products[review.productId] || null;
        
        // If product not found in localStorage, try to get from Firestore
        if (!product) {
          try {
            const productDoc = await db.collection('products').doc(review.productId).get();
            if (productDoc.exists) {
              product = productDoc.data();
            }
          } catch (error) {
            console.error("Error getting product:", error);
          }
        }
        
        // Default product info if not found
        const productName = product ? product.name : 'Unknown Product';
        const productImage = product ? product.imageUrl : 'images/default-product.jpg';
        
        // Generate stars HTML
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
          if (i <= review.rating) {
            starsHtml += '<i class="fas fa-star"></i>';
          } else {
            starsHtml += '<i class="far fa-star"></i>';
          }
        }
        
        const reviewItem = document.createElement('div');
        reviewItem.className = 'review-item';
        reviewItem.innerHTML = `
          <img src="${productImage}" alt="${productName}" class="product-image">
          <div class="review-content">
            <div class="product-name">${productName}</div>
            <div class="review-date">${review.createdAt.toLocaleDateString()}</div>
            <div class="review-rating">
              ${starsHtml}
            </div>
            <div class="review-text">
              <div class="review-title">${review.title || ''}</div>
              <div class="review-body">${review.content}</div>
            </div>
            <div class="review-actions">
              <a href="product_reviews.html?id=${review.productId}" class="review-btn edit-btn">View Product</a>
              <a href="#" class="review-btn delete-btn" data-review-id="${review.id}">Delete Review</a>
            </div>
          </div>
        `;
        
        reviewsListEl.appendChild(reviewItem);
      }
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const reviewId = this.getAttribute('data-review-id');
          deleteReview(reviewId);
        });
      });
    }
    
    // Show empty state
    function showEmptyState() {
      reviewsListEl.innerHTML = `
        <div class="empty-reviews">
          <i class="fas fa-star"></i>
          <h3>No Reviews Yet</h3>
          <p>You haven't reviewed any products yet. Start shopping and share your thoughts!</p>
          <a href="products.html" class="shop-now-btn">Shop Now</a>
        </div>
      `;
    }
    
    // Delete review
    async function deleteReview(reviewId) {
      if (confirm('Are you sure you want to delete this review?')) {
        try {
          await db.collection('reviews').doc(reviewId).delete();
          alert('Review deleted successfully!');
          
          // Reload reviews
          const user = auth.currentUser;
          if (user) {
            loadUserReviews(user.uid);
          }
        } catch (error) {
          console.error("Error deleting review:", error);
          alert('Error deleting review. Please try again.');
        }
      }
    }
    
    // Logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = 'login.html';
      }).catch((error) => {
        alert(error.message);
      });
    });
  </script>
</body>
</html>
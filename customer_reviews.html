<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soko freshi Store - Customer Reviews</title>
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <link rel="shortcut icon" href="images/favicon.png" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css" integrity="sha384-eLT4eRYPHTmTsFGFAzjcCWX+wHfUInVWNm9YnwpiatljsZOwXtwV2Hh6sHM6zZD9" crossorigin="anonymous" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,
    600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>
    .dashboard-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      flex: 1;
      min-width: 200px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      text-align: center;
    }
    
    .stat-card h4 {
      color: #666;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .stat-card .number {
      font-size: 28px;
      font-weight: 700;
      color: #0dd134;
    }
    
    .product-review-header {
      display: flex;
      align-items: center;
      margin-top: 30px;
      margin-bottom: 15px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .product-review-header img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 15px;
    }
    
    .product-review-header .product-info {
      flex: 1;
    }
    
    .product-review-header h4 {
      margin: 0 0 5px 0;
      color: #333;
      font-size: 18px;
    }
    
    .product-review-header .product-meta {
      color: #666;
      font-size: 14px;
    }
    
    .review-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    
    .reviewer-info {
      display: flex;
      align-items: center;
    }
    
    .reviewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      color: #495057;
      font-weight: bold;
    }
    
    .reviewer-name {
      font-weight: 600;
      color: #333;
    }
    
    .review-date {
      color: #777;
      font-size: 0.9em;
    }
    
    .rating {
      color: #ffc107;
      font-size: 18px;
      margin-bottom: 10px;
    }
    
    .review-content {
      color: #333;
      line-height: 1.6;
    }
    
    .review-actions {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    
    .review-btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .reply-btn {
      background-color: #e9ecef;
      color: #495057;
    }
    
    .reply-btn:hover {
      background-color: #dee2e6;
    }
    
    .no-reviews-action {
      margin-top: 30px;
      text-align: center;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 30px;
    }
    
    .no-reviews-action p {
      color: #666;
      margin-bottom: 15px;
    }
    
    .action-btn {
      display: inline-flex;
      align-items: center;
      background-color: #0dd134;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    
    .action-btn:hover {
      background-color: #0bb02e;
    }
    
    .action-btn i {
      margin-right: 8px;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .filter-btn {
      padding: 8px 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      color: #495057;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background-color: #0dd134;
      color: white;
      border-color: #0dd134;
    }
    
    .filter-btn:hover:not(.active) {
      background-color: #e9ecef;
    }
  </style>
</head>

<body>
  <nav class="navigation">
    <a href="index.html" class="logo">
      Soko freshi
    </a>
    <input type="checkbox" class="menu-btn" id="menu-btn">
    <label for="menu-btn" class="menu-icon">
      <span class="nav-icon"></span>
    </label>
    <ul class="menu">
      <li><a href="vendor_dashboard.html">Dashboard</a></li>
      <li><a href="add_product.html">Add Product</a></li>
      <li><a href="manage_products.html">Manage Products</a></li>
      <li><a href="sales_history.html">Sales History</a></li>
      <li><a href="customer_reviews.html" class="active">Customer Reviews</a></li>
    </ul>
  </nav>

  <section id="clients">
    <div class="dashboard-container">
      <div class="client-heading">
        <h3>Customer Reviews</h3>
      </div>
      
      <div class="stats-container">
        <div class="stat-card">
          <h4>Total Reviews</h4>
          <div class="number" id="total-reviews">0</div>
        </div>
        <div class="stat-card">
          <h4>Average Rating</h4>
          <div class="number" id="average-rating">0.0</div>
        </div>
        <div class="stat-card">
          <h4>Products Reviewed</h4>
          <div class="number" id="products-reviewed">0</div>
        </div>
      </div>
      
      <div class="filters">
        <button class="filter-btn active" data-filter="all">All Reviews</button>
        <button class="filter-btn" data-filter="5">5 Star</button>
        <button class="filter-btn" data-filter="4">4 Star</button>
        <button class="filter-btn" data-filter="3">3 Star</button>
        <button class="filter-btn" data-filter="1-2">1-2 Star</button>
      </div>
      
      <div id="reviews-container">
        <!-- Reviews will be loaded here -->
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-container">
       <div class="footer-logo">
         <a href="#">Soko freshi</a>
         <div class="footer-social">
           <a href="#">
             <i class="fa-brands fa-facebook" style="color: #3a87fe;"></i>
             <i class="fa-brands fa-instagram" style="color: #e1306c;"></i>
             <i class="fa-brands fa-twitter" style="color: #11d6cc;"></i>
             <i class="fa-brands fa-youtube" style="color: #ff0800;"></i>
           </a>
         </div>
       </div>
       <div class="footer-links">
         <strong>Product</strong>
         <ul>
           <li>
             <a href="#">Clothes</a>
           </li>
           <li>
             <a href="#">Packages</a>
           </li>
           <li>
             <a href="#">Popular</a>
           </li>
           <li>
             <a href="#">New</a>
           </li>
         </ul>
       </div>
       <div class="footer-links">
         <strong>Category</strong>
         <ul>
           <li>
             <a href="#">Beauty</a>
           </li>
           <li>
             <a href="#">Meats</a>
           </li>
           <li>
             <a href="#">Kids</a>
           </li>
           <li>
             <a href="#">Clothes</a>
           </li>
         </ul>
       </div>
       <div class="footer-links">
         <strong>Contact</strong>
         <ul>
           <li>
             <a href="#">Phone: ++254 758 599393</a>
           </li>
           <li>
             <a href="#">Email: angie@gmail.com</a>
           </li>
         </ul>
       </div>
    </div>
  </footer>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="js/firebase-init.js"></script>
  <script>
    const reviewsContainer = document.getElementById('reviews-container');
    
    // Filter reviews by rating
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('filter-btn')) {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        e.target.classList.add('active');
        
        // Get filter value
        const filter = e.target.getAttribute('data-filter');
        
        // Filter reviews
        const reviews = document.querySelectorAll('.review-card');
        reviews.forEach(review => {
          const rating = parseInt(review.getAttribute('data-rating'));
          
          if (filter === 'all') {
            review.style.display = 'block';
          } else if (filter === '5' && rating === 5) {
            review.style.display = 'block';
          } else if (filter === '4' && rating === 4) {
            review.style.display = 'block';
          } else if (filter === '3' && rating === 3) {
            review.style.display = 'block';
          } else if (filter === '1-2' && (rating === 1 || rating === 2)) {
            review.style.display = 'block';
          } else {
            review.style.display = 'none';
          }
        });
      }
    });

    // Check if user is a vendor
    auth.onAuthStateChanged(async user => {
      if (user) {
        const userRole = localStorage.getItem('userRole');
        if (userRole !== 'vendor') {
          alert('You are not authorized to view this page.');
          window.location.href = 'index.html';
        } else {
          try {
            // Show loading message
            reviewsContainer.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 30px; color: #0dd134;"></i><p>Loading reviews...</p></div>';
            
            // Fetch and display reviews for vendor's products
            const productsQuery = await db.collection('products').where('vendorId', '==', user.uid).get();
            reviewsContainer.innerHTML = ''; // Clear existing items
            
            let hasReviews = false;
            let totalReviews = 0;
            let totalRating = 0;
            let reviewedProducts = new Set();
            
            for (const productDoc of productsQuery.docs) {
              const productId = productDoc.id;
              const productData = productDoc.data();
              
              try {
                const reviewsQuery = await db.collection('reviews').where('productId', '==', productId).get();
                
                if (reviewsQuery.docs.length > 0) {
                  hasReviews = true;
                  totalReviews += reviewsQuery.docs.length;
                  reviewedProducts.add(productId);
                  
                  // Calculate total rating
                  reviewsQuery.forEach(doc => {
                    const review = doc.data();
                    totalRating += parseInt(review.rating) || 0;
                  });
                  
                  // Add product name as a header with image
                  const productImage = productData.imageUrl || 'images/default-product.jpg';
                  reviewsContainer.innerHTML += `
                    <div class="product-review-header">
                      <img src="${productImage}" alt="${productData.name}">
                      <div class="product-info">
                        <h4>${productData.name || 'Product'}</h4>
                        <div class="product-meta">
                          Category: ${productData.category || 'Uncategorized'} • ${reviewsQuery.docs.length} reviews
                        </div>
                      </div>
                    </div>
                  `;
                  
                  reviewsQuery.forEach(reviewDoc => {
                    const review = reviewDoc.data();
                    const reviewDate = review.createdAt ? new Date(review.createdAt.toDate ? review.createdAt.toDate() : review.createdAt).toLocaleDateString() : 'Recent';
                    const reviewerInitial = (review.userName || 'A')[0].toUpperCase();
                    
                    const reviewHtml = `
                      <div class="review-card" data-rating="${review.rating || 0}">
                        <div class="review-header">
                          <div class="reviewer-info">
                            <div class="reviewer-avatar">${reviewerInitial}</div>
                            <div>
                              <div class="reviewer-name">${review.userName || 'Anonymous'}</div>
                              <div class="review-date">${reviewDate}</div>
                            </div>
                          </div>
                        </div>
                        <div class="rating">
                          ${[...Array(parseInt(review.rating) || 0)].map(() => '<i class="fas fa-star"></i>').join('')}
                          ${[...Array(5 - (parseInt(review.rating) || 0))].map(() => '<i class="far fa-star"></i>').join('')}
                        </div>
                        <div class="review-content">
                          <p>${review.comment || 'No comment provided'}</p>
                        </div>
                        <div class="review-actions">
                          <button class="review-btn reply-btn"><i class="fas fa-reply"></i> Reply</button>
                        </div>
                      </div>
                    `;
                    reviewsContainer.innerHTML += reviewHtml;
                  });
                }
              } catch (reviewError) {
                console.error("Error fetching reviews for product:", reviewError);
              }
            }
            
            // Update statistics
            document.getElementById('total-reviews').textContent = totalReviews;
            document.getElementById('average-rating').textContent = totalReviews > 0 ? (totalRating / totalReviews).toFixed(1) : '0.0';
            document.getElementById('products-reviewed').textContent = reviewedProducts.size;
            
            if (!hasReviews) {
              reviewsContainer.innerHTML = `
                <div class="no-reviews-action">
                  <img src="images/review-empty.png" alt="No Reviews" style="width: 120px; margin-bottom: 20px; opacity: 0.7;">
                  <h3>No Reviews Yet</h3>
                  <p>You haven't received any customer reviews for your products yet.</p>
                  <p>Encourage customers to leave reviews by providing excellent service and quality products.</p>
                  <a href="manage_products.html" class="action-btn">
                    <i class="fas fa-box"></i> Manage Your Products
                  </a>
                </div>
              `;
            }
          } catch (error) {
            console.error("Error loading reviews:", error);
            reviewsContainer.innerHTML = '<div class="client-box"><p>Error loading reviews. Please try again later.</p></div>';
          }
        }
      } else {
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Soko freshi Store - My Orders</title>
  <link rel="stylesheet" type="text/css" href="css/style.css" />
  <link rel="shortcut icon" href="images/favicon.png" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.1.0/css/all.css" integrity="sha384-eLT4eRYPHTmTsFGFAzjcCWX+wHfUInVWNm9YnwpiatljsZOwXtwV2Hh6sHM6zZD9" crossorigin="anonymous" />
  <style>
    .orders-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    .order-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }
    .summary-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 15px;
      flex: 1;
      min-width: 200px;
      text-align: center;
    }
    .summary-card .icon {
      font-size: 24px;
      color: #0dd134;
      margin-bottom: 10px;
    }
    .summary-card .count {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .summary-card .label {
      color: #666;
      font-size: 14px;
    }
    .order-list {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .order-item {
      border-bottom: 1px solid #eee;
      padding: 15px;
    }
    .order-item:last-child {
      border-bottom: none;
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .order-id {
      font-weight: bold;
      color: #333;
    }
    .order-date {
      color: #666;
      font-size: 14px;
    }
    .order-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }
    .status-processing {
      background-color: #fff3cd;
      color: #856404;
    }
    .status-shipped {
      background-color: #cce5ff;
      color: #004085;
    }
    .status-cancelled {
      background-color: #f8d7da;
      color: #721c24;
    }
    .order-details {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }
    .order-products {
      flex: 2;
      min-width: 300px;
    }
    .product-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .product-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 5px;
      margin-right: 10px;
    }
    .product-info {
      flex: 1;
    }
    .product-name {
      font-weight: 500;
      margin-bottom: 3px;
    }
    .product-price {
      color: #666;
      font-size: 14px;
    }
    .order-summary-box {
      flex: 1;
      min-width: 200px;
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .summary-row.total {
      font-weight: bold;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      margin-top: 8px;
    }
    .order-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .order-btn {
      padding: 8px 15px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }
    .track-btn {
      background-color: #0dd134;
      color: white;
    }
    .reorder-btn {
      background-color: #f8f9fa;
      color: #333;
      border: 1px solid #ddd;
    }
    .empty-orders {
      text-align: center;
      padding: 40px 20px;
    }
    .empty-orders i {
      font-size: 60px;
      color: #ddd;
      margin-bottom: 20px;
    }
    .empty-orders h3 {
      margin-bottom: 15px;
      color: #333;
    }
    .empty-orders p {
      color: #666;
      margin-bottom: 20px;
    }
    .shop-now-btn {
      display: inline-block;
      background-color: #0dd134;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <nav class="navigation">
    <a href="index.html" class="logo">
      Soko freshi
    </a>
    <input type="checkbox" class="menu-btn" id="menu-btn">
    <label for="menu-btn" class="menu-icon">
      <span class="nav-icon"></span>
    </label>
    <ul class="menu">
      <li><a href="index.html">Home</a></li>
      <li><a href="products.html">Products</a></li>
      <li><a href="my_orders.html" class="active">My Orders</a></li>
    </ul>
    <div class="right-nav">
      <a href="#" class="like">
        <i class="far fa-heart"></i>
        <span>0</span>
      </a>
      <a href="cart.html" class="cart">
        <i class="fa fa-shopping-cart"></i>
        <span>0</span>
      </a>
      <a href="#" id="logout-btn" class="logout">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </div>
  </nav>

  <section id="popular-product">
    <div class="product-heading">
      <h3>My Orders</h3>
      <span></span>
    </div>
    
    <div class="orders-container">
      <div class="order-summary">
        <div class="summary-card">
          <div class="icon"><i class="fas fa-shopping-bag"></i></div>
          <div class="count" id="total-orders">0</div>
          <div class="label">Total Orders</div>
        </div>
        <div class="summary-card">
          <div class="icon"><i class="fas fa-truck"></i></div>
          <div class="count" id="processing-orders">0</div>
          <div class="label">Processing</div>
        </div>
        <div class="summary-card">
          <div class="icon"><i class="fas fa-check-circle"></i></div>
          <div class="count" id="delivered-orders">0</div>
          <div class="label">Delivered</div>
        </div>
        <div class="summary-card">
          <div class="icon"><i class="fas fa-money-bill-wave"></i></div>
          <div class="count" id="total-spent">Ksh0</div>
          <div class="label">Total Spent</div>
        </div>
      </div>
      
      <div id="orders-list">
        <!-- Orders will be loaded here -->
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-container">
      <div class="footer-logo">
        <a href="#">Soko freshi</a>
        <div class="footer-social">
          <a href="#"><i class="fab fa-facebook-f"></i></a>
          <a href="#"><i class="fab fa-twitter"></i></a>
          <a href="#"><i class="fab fa-instagram"></i></a>
        </div>
      </div>
      <div class="footer-links">
        <strong>Quick Links</strong>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="products.html">Products</a></li>
          <li><a href="my_orders.html">My Orders</a></li>
          <li><a href="contact.html">Contact Us</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <strong>Categories</strong>
        <ul>
          <li><a href="products.html?category=Fruits">Fruits</a></li>
          <li><a href="products.html?category=Vegetables">Vegetables</a></li>
          <li><a href="products.html?category=Fish & Meat">Fish & Meat</a></li>
          <li><a href="products.html?category=Spices">Spices</a></li>
        </ul>
      </div>
      <div class="footer-links">
        <strong>Contact Us</strong>
        <ul>
          <li><i class="fas fa-map-marker-alt"></i> 123, ABC Street, XYZ City</li>
          <li><i class="fas fa-phone-alt"></i> +254 758 599393</li>
          <li><i class="fas fa-envelope"></i> angie@gmail.com</li>
        </ul>
      </div>
    </div>
  </footer>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB4H9MQ76i1p3tThi6Zoc-AGbfnqjBSLRI",
      authDomain: "efresh-56b75.firebaseapp.com",
      projectId: "efresh-56b75",
      storageBucket: "efresh-56b75.firebasestorage.app",
      messagingSenderId: "253998754664",
      appId: "1:253998754664:web:889840cf5d84ef903a84dd"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM elements
    const totalOrdersEl = document.getElementById('total-orders');
    const processingOrdersEl = document.getElementById('processing-orders');
    const deliveredOrdersEl = document.getElementById('delivered-orders');
    const totalSpentEl = document.getElementById('total-spent');
    const ordersListEl = document.getElementById('orders-list');
    
    // Get orders from localStorage
    function getOrdersFromLocalStorage() {
      const ordersData = localStorage.getItem('orders');
      if (!ordersData) return [];
      
      try {
        const orders = JSON.parse(ordersData);
        // Convert date strings back to Date objects
        return orders.map(order => ({
          ...order,
          date: new Date(order.date)
        }));
      } catch (error) {
        console.error('Error parsing orders:', error);
        return [];
      }
    }
    
    // Check if user is logged in
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // User is logged in
        try {
          // Get user data
          const userDoc = await db.collection('users').doc(user.uid).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            
            // Check if user is a customer
            if (userData.role && userData.role !== 'customer') {
              alert('This page is for customers only.');
              window.location.href = 'index.html';
              return;
            }
          }
          
          // Get orders from localStorage first
          let orders = getOrdersFromLocalStorage();
          
          // If no orders in localStorage, try to get from Firestore
          if (orders.length === 0) {
            try {
              const ordersQuery = await db.collection('orders').where('userId', '==', user.uid).get();
              if (!ordersQuery.empty) {
                ordersQuery.forEach(doc => {
                  orders.push({
                    id: doc.id,
                    ...doc.data(),
                    date: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date()
                  });
                });
              }
            } catch (firestoreError) {
              console.error("Error loading orders from Firestore:", firestoreError);
            }
          }
          
          // Update order summary
          updateOrderSummary(orders);
          
          // Display orders
          displayOrders(orders);
          
        } catch (error) {
          console.error("Error loading orders:", error);
          // Use localStorage orders if there's an error
          const orders = getOrdersFromLocalStorage();
          updateOrderSummary(orders);
          displayOrders(orders);
        }
      } else {
        // Not logged in, redirect to login
        window.location.href = 'login.html';
      }
    });
    
    // Update order summary
    function updateOrderSummary(orders) {
      // Total orders
      totalOrdersEl.textContent = orders.length;
      
      // Processing orders
      const processingOrders = orders.filter(order => 
        order.status === 'processing' || order.status === 'shipped'
      );
      processingOrdersEl.textContent = processingOrders.length;
      
      // Delivered orders
      const deliveredOrders = orders.filter(order => order.status === 'delivered');
      deliveredOrdersEl.textContent = deliveredOrders.length;
      
      // Total spent
      const totalSpent = orders.reduce((total, order) => total + order.total, 0);
      totalSpentEl.textContent = `Ksh${totalSpent}`;
    }
    
    // Display orders
    function displayOrders(orders) {
      if (orders.length === 0) {
        // Show empty state
        ordersListEl.innerHTML = `
          <div class="empty-orders">
            <i class="fas fa-shopping-bag"></i>
            <h3>No Orders Yet</h3>
            <p>You haven't placed any orders yet. Start shopping to see your orders here.</p>
            <a href="products.html" class="shop-now-btn">Shop Now</a>
          </div>
        `;
        return;
      }
      
      // Sort orders by date (newest first)
      orders.sort((a, b) => b.date - a.date);
      
      // Create HTML for each order
      let ordersHTML = '';
      
      orders.forEach(order => {
        // Get status class
        let statusClass = '';
        switch (order.status) {
          case 'delivered':
            statusClass = 'status-delivered';
            break;
          case 'processing':
            statusClass = 'status-processing';
            break;
          case 'shipped':
            statusClass = 'status-shipped';
            break;
          case 'cancelled':
            statusClass = 'status-cancelled';
            break;
          default:
            statusClass = 'status-processing';
        }
        
        // Create products HTML
        let productsHTML = '';
        order.items.forEach(item => {
          productsHTML += `
            <div class="product-item">
              <img src="${item.image}" alt="${item.name}" class="product-image">
              <div class="product-info">
                <div class="product-name">${item.name}</div>
                <div class="product-price">Ksh${item.price} x ${item.quantity}</div>
              </div>
            </div>
          `;
        });
        
        // Create order HTML
        ordersHTML += `
          <div class="order-item">
            <div class="order-header">
              <div class="order-id">Order #${order.id}</div>
              <div class="order-date">${order.date instanceof Date ? order.date.toLocaleDateString() : new Date(order.date).toLocaleDateString()}</div>
              <div class="order-status ${statusClass}">${order.status}</div>
            </div>
            <div class="order-details">
              <div class="order-products">
                ${productsHTML}
              </div>
              <div class="order-summary-box">
                <div class="summary-row">
                  <span>Subtotal:</span>
                  <span>Ksh${order.subtotal}</span>
                </div>
                <div class="summary-row">
                  <span>Shipping:</span>
                  <span>Ksh${order.shipping}</span>
                </div>
                <div class="summary-row total">
                  <span>Total:</span>
                  <span>Ksh${order.total}</span>
                </div>
              </div>
            </div>
            <div class="order-actions">
              <a href="track_order.html?id=${order.id}" class="order-btn track-btn">Track Order</a>
              <a href="#" class="order-btn reorder-btn">Reorder</a>
            </div>
          </div>
        `;
      });
      
      // Add to orders list
      ordersListEl.innerHTML = `<div class="order-list">${ordersHTML}</div>`;
    }
    
    // Logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        window.location.href = 'index.html';
      }).catch((error) => {
        alert(error.message);
      });
    });
  </script>
</body>
</html>